<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">
<style>
/* =====================
   ADMIN STYLES (clean, professional)
===================== */
.admin-wrapper{
  padding:18px var(--gutter);
  max-width:1200px;
  margin:0 auto;
}

.admin-card{
  width:100%;
  background:transparent;
  padding:0;
}

.admin-layout{ 
  display:flex; 
  gap:22px; 
  align-items:flex-start; 
}

/* Left list */
.admin-jobs{
  flex:1;
  background:var(--surface);
  padding:18px;
  border-radius:10px;
  max-height: calc(100vh - 160px);
  overflow-y:auto;
  box-shadow: 0 10px 30px rgba(2,6,23,0.35);
}

#jobsListAdmin > div{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px;
  border-radius:8px;
  margin-bottom:10px;
  cursor:pointer;
  transition: background .12s ease, transform .08s ease;
}
#jobsListAdmin > div:hover{ 
  background: rgba(255,255,255,0.03); 
  transform: translateY(-2px); 
}

/* Right detail panel */
.job-detail{ 
  width:420px; 
  flex:0 0 420px; 
  background:var(--surface-2); 
  padding:18px; 
  border-radius:10px; 
  box-shadow: 0 8px 30px rgba(2,6,23,0.18); 
  max-height: calc(100vh - 160px); 
  overflow:auto; 
  position:sticky; 
  top:20px 
}
#detailTitle{ font-weight:700; margin-bottom:8px; }
#detailRaw{ 
  white-space:pre-wrap; 
  color:var(--muted); 
  background:transparent; 
  padding:0; 
  border-radius:6px 
}

/* Announcement box */
#currentAnnouncement{ margin-top:12px }
#currentAnnouncement > div{ 
  padding:12px; 
  background:var(--surface); 
  border-radius:8px; 
}

/* Inputs & buttons */
.admin-card input,
.admin-card textarea{
  width:100%;
  margin-top:.8rem;
  padding:14px 16px;
  border-radius:16px;
  background:rgba(255,255,255,.12);
  border:1px solid var(--border, rgba(255,255,255,0.1));
  color:white;
  outline:none;
  font-family: inherit;
  font-size: 1rem;
}

.admin-card button{
  width:100%;
  margin-top:1rem;
  padding:14px;
  border-radius:14px;
  background:var(--accent);
  border:none;
  color:white;
  font-weight:600;
  cursor:pointer;
  transition: opacity .15s;
}
.admin-card button:hover { opacity: 0.9; }

.admin-card .danger{
  background:#ef4444;
}

/* Utility buttons */
.btn{ 
  display:inline-block; 
  padding:10px 14px; 
  border-radius:12px; 
  font-weight:600; 
  cursor:pointer; 
}
.btn-primary{ background:var(--accent); color:white; border:none; }
.btn-primary-outline{ 
  background:transparent; 
  color:var(--accent); 
  border:2px solid rgba(10,132,255,0.15); 
}

/* HR */
.admin-card hr{ 
  margin:2rem 0; 
  opacity:.25; 
  border:none;
  height:1px;
  background: rgba(255,255,255,0.1);
}

/* Mobile fallback */
@media (max-width: 767px){
  .admin-layout{ flex-direction:column; }
  .job-detail{ 
    width:100%; 
    position:relative; 
    top:auto; 
    max-height: none;
  }
}

/* Scrollbars */
.admin-jobs::-webkit-scrollbar, 
.job-detail::-webkit-scrollbar { 
  width:8px; 
}
.admin-jobs::-webkit-scrollbar-thumb, 
.job-detail::-webkit-scrollbar-thumb { 
  background: rgba(255,255,255,0.1); 
  border-radius:10px; 
}
</style>
</head>

<body>

<header class="top-header">
  <h1>Admin Panel</h1>
  <p>Post jobs & announcements</p>
</header>

<div class="admin-wrapper">

  <!-- LOGIN -->
  <div class="admin-card" id="loginBox">
    <h3>üîê Admin Login</h3>
    <input id="password" type="password" placeholder="Enter password">
    <button onclick="login()">Login</button>
  </div>

  <!-- PANEL -->
  <div class="admin-card" id="adminBox" style="display:none">

    <h3>‚ûï Post Job</h3>
    <textarea id="jobText" rows="8" placeholder="üéØ iOPEX Walkin Drive
‚ú≥Ô∏èRole: Finance Executive
‚ùáÔ∏èQualification: Any Graduate
üÉèExperience: 1-4 Years
üîîDate: 19 December
üëâApply Link: https://example.com"></textarea>
    <button class="btn btn-primary" onclick="postJob()">Publish Job</button>

    <div class="admin-layout" style="margin-top:1rem">
      <div id="adminJobs" class="admin-jobs">
        <h3>üìã Existing Jobs</h3>
        <div id="adminMetrics" style="opacity:.85;margin-bottom:8px"></div>
        <div id="jobsListAdmin"></div>
      </div>

      <div id="jobDetailAdmin" class="job-detail" style="display:none">
        <h3 id="detailTitle">Select a job</h3>
        <pre id="detailRaw" style="white-space:pre-wrap;margin-top:8px;padding:8px;background:rgba(255,255,255,0.03);border-radius:8px;">No job selected</pre>
        <div id="detailCounts" style="opacity:.85;margin-top:8px"></div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="detailEditBtn" onclick="editJob(selectedJobIdx)" style="padding:8px 10px;border-radius:10px;background:#0a84ff;border:none;color:white;cursor:pointer">Edit</button>
          <button id="detailDeleteBtn" onclick="deleteJob(selectedJobIdx)" style="padding:8px 10px;border-radius:10px;background:#ef4444;border:none;color:white;cursor:pointer">Delete</button>
        </div>
      </div>
    </div>

    <hr>  

    <h3>üì£ Announcement</h3>
    <textarea id="annText" rows="3" placeholder="Short announcement message"></textarea>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn btn-primary-outline" onclick="postAnnouncement()">Publish Announcement</button>
    </div>

    <div id="currentAnnouncement" style="margin-top:12px"></div>

    <button class="danger" onclick="logout()">Logout</button>
  </div>

</div>

<!-- Toast -->
<div class="toast" id="toastAdmin" style="top:18px;right:18px;position:fixed;z-index:10001;display:flex;align-items:center;gap:8px;">
  <span id="toastTextAdmin"></span>
  <button id="toastUndoBtn" style="display:none;padding:6px 10px;border-radius:10px;background:#0a84ff;border:none;color:white;cursor:pointer" onclick="restoreLastDeleted()">Undo</button>
  <button onclick="hideToastAdmin()">‚úï</button>
</div> 

<script src="firebase-config.js"></script>
<script src="firebase.js"></script>
<script>
const ADMIN_PASSWORD = "change123";

const loginBox = document.getElementById("loginBox");
const adminBox = document.getElementById("adminBox");

function login(){
  if(password.value === ADMIN_PASSWORD){
    localStorage.setItem("admin","true");
    showAdmin();
    renderAdminJobs();
  } else showToastAdmin("Wrong password");
} 

function logout(){
  localStorage.removeItem("admin");
  location.reload();
}

function showAdmin(){
  loginBox.style.display="none";
  adminBox.style.display="block";
}

if(localStorage.getItem("admin")==="true") showAdmin();

// Toast helpers for admin
let selectedJobIdx = null;
let lastDeleted = null;

function showToastAdmin(txt, duration = 5000, showUndo = false){
  const t = document.getElementById('toastAdmin');
  const tt = document.getElementById('toastTextAdmin');
  const undoBtn = document.getElementById('toastUndoBtn');
  if(!t || !tt) return;
  tt.innerText = txt || '';
  if(undoBtn) undoBtn.style.display = showUndo ? 'inline-block' : 'none';
  t.classList.add('show');
  if(t._hideTimeout) clearTimeout(t._hideTimeout);
  t._hideTimeout = setTimeout(()=>{ t.classList.remove('show'); t._hideTimeout = null; if(undoBtn) undoBtn.style.display='none'; }, duration);
}
function hideToastAdmin(){ 
  const t = document.getElementById('toastAdmin'); 
  if(!t) return; 
  t.classList.remove('show'); 
  if(t._hideTimeout) clearTimeout(t._hideTimeout); 
  const undoBtn = document.getElementById('toastUndoBtn'); 
  if(undoBtn) undoBtn.style.display='none'; 
}

function showJobDetail(idx){
  const jobs = JSON.parse(localStorage.getItem("jobs")) || [];
  if(idx < 0 || idx >= jobs.length) return;
  selectedJobIdx = idx;
  const j = jobs[idx];
  const title = document.getElementById('detailTitle');
  const raw = document.getElementById('detailRaw');
  const counts = document.getElementById('detailCounts');
  title.innerText = j.title || 'Job detail';
  raw.innerText = j.raw || '';
  counts.innerText = `üëÅÔ∏è Views: ${j.views || 0} ‚Ä¢ üîó Applies: ${j.applies || 0}`;
  document.getElementById('jobDetailAdmin').style.display = 'block';
}

function restoreLastDeleted(){
  try{
    const raw = localStorage.getItem('lastDeletedJob');
    if(!raw) return showToastAdmin('Nothing to restore');
    const item = JSON.parse(raw);
    const jobs = JSON.parse(localStorage.getItem("jobs")) || [];
    const idx = Math.min(item.idx, jobs.length);
    jobs.splice(idx,0,item.job);
    localStorage.setItem("jobs", JSON.stringify(jobs));
    localStorage.removeItem('lastDeletedJob');
    lastDeleted = null;
    renderAdminJobs();
    showToastAdmin('Job restored');
  }catch(e){ console.error(e); showToastAdmin('Unable to restore'); }
}

// React to changes from other tabs / Firebase
window.addEventListener('storage', e => {
  if(e.key === 'announcement'){
    showToastAdmin(e.newValue || 'Announcement posted');
    renderAnnouncementAdmin();
  }
  if(e.key === 'jobs'){
    renderAdminJobs();
  }
  if(e.key === 'lastDeletedJob'){
    lastDeleted = localStorage.getItem('lastDeletedJob') ? JSON.parse(localStorage.getItem('lastDeletedJob')) : null;
  }
});

function renderAnnouncementAdmin(){
  const el = document.getElementById('currentAnnouncement');
  if(!el) return;
  const ann = localStorage.getItem('announcement') || '';
  if(!ann){ 
    el.innerHTML = "<p style='opacity:.7'>No announcement</p>"; 
    return; 
  }
  el.innerHTML = `<div style="padding:10px;background:rgba(255,255,255,0.02);border-radius:8px;white-space:pre-wrap">${ann}</div>
  <div style="margin-top:8px;display:flex;gap:8px">
    <button class="btn btn-primary-outline" onclick="editAnnouncement()">Edit</button>
    <button onclick="deleteAnnouncement()" style="padding:8px 10px;border-radius:10px;background:#ef4444;border:none;color:white;cursor:pointer">Delete</button>
  </div>`;
}

function editAnnouncement(){
  const ann = localStorage.getItem('announcement') || '';
  annText.value = ann;
  annText.focus();
}

async function deleteAnnouncement(){
  if(!confirm('Delete announcement?')) return;
  if(window.firebaseEnabled){
    const success = await window.firebaseSetAnnouncement('');
    if(success) showToastAdmin('Announcement deleted');
    else showToastAdmin('Error deleting announcement');
  } else {
    localStorage.removeItem('announcement');
    showToastAdmin('Announcement deleted (local)');
  }
  renderAnnouncementAdmin();
}

if(localStorage.getItem("admin")==="true") renderAnnouncementAdmin();

/* JOB POST */
async function postJob(){
  try{
    const raw = (jobText.value || "").trim();
    if(!raw) return showToastAdmin("Please enter job details");

    const firstLine = raw.split('\n')[0].replace(/^üéØ\s*/,'').trim();
    const title = firstLine || 'Untitled Job';
    const urlMatch = raw.match(/https?:\/\/\S+/i);
    const id = 'job_' + Date.now();
    const job = {
      id,
      title,
      raw,
      apply: urlMatch ? urlMatch[0] : '',
      views: 0,
      applies: 0,
      createdAt: Date.now()
    };

    if(window.firebaseEnabled){
      const success = await window.firebasePushJob(job);
      if(success){
        showToastAdmin("Job posted and synced");
        jobText.value="";
        return; // Firebase listener will update UI
      } else {
        showToastAdmin("Firebase error ‚Äì falling back to local");
      }
    }

    // Local fallback
    const jobs = JSON.parse(localStorage.getItem("jobs")) || [];
    jobs.unshift(job);
    localStorage.setItem("jobs", JSON.stringify(jobs));
    renderAdminJobs();
    showToastAdmin("Job posted (local only)");
    jobText.value="";
  }catch(e){
    console.error(e);
    showToastAdmin("Error posting job");
  }
} 

/* ANNOUNCEMENT */
async function postAnnouncement(){
  const txt = (annText.value || '').trim();
  if(!txt) return showToastAdmin('Please enter announcement');

  if(window.firebaseEnabled){
    const success = await window.firebaseSetAnnouncement(txt);
    if(success){
      showToastAdmin("Announcement posted and synced");
      annText.value="";
      renderAnnouncementAdmin();
      return;
    } else {
      showToastAdmin("Firebase error ‚Äì falling back to local");
    }
  }

  localStorage.setItem("announcement", txt);
  showToastAdmin("Announcement posted (local only)");
  annText.value="";
  renderAnnouncementAdmin();
} 

/* ADMIN JOBS LIST */
function renderAdminJobs(){
  const jobs = JSON.parse(localStorage.getItem("jobs")) || [];
  const list = document.getElementById("jobsListAdmin");
  if(!list) return;
  list.innerHTML = "";
  if(jobs.length === 0){
    list.innerHTML = "<p style='opacity:.7'>No jobs posted</p>";
    return;
  }

  const metricsEl = document.getElementById('adminMetrics');
  if(metricsEl){
    const totalViews = jobs.reduce((s,j)=>s+(j.views||0),0);
    const totalApplies = jobs.reduce((s,j)=>s+(j.applies||0),0);
    metricsEl.innerText = `Total Views: ${totalViews} ‚Ä¢ Total Applies: ${totalApplies}`;
  }

  jobs.forEach((job, idx) => {
    const row = document.createElement("div");
    const lines = (job.raw||"").split('\n').map(l=>l.trim()).filter(Boolean);
    const excerpt = lines[1] ? lines[1] : (lines[0] && lines[0].length>60 ? lines[0].slice(0,60)+'...' : lines[0]||'');
    row.innerHTML = `<div>
        <strong>${job.title}</strong>
        <div style="opacity:.85;font-size:.9rem">${excerpt}</div>
        <div style="opacity:.7;font-size:.85rem;margin-top:6px">üëÅÔ∏è ${job.views||0} ‚Ä¢ üîó ${job.applies||0}</div>
      </div>
      <div style="display:flex;gap:8px">
        <button onclick="event.stopPropagation(); editJob(${idx})" style="padding:8px 10px;border-radius:10px;background:#0a84ff;border:none;color:white;cursor:pointer">Edit</button>
        <button onclick="event.stopPropagation(); deleteJob(${idx})" style="padding:8px 10px;border-radius:10px;background:#ef4444;border:none;color:white;cursor:pointer">Delete</button>
      </div>`;
    row.onclick = () => showJobDetail(idx);
    list.appendChild(row);
  });
}

async function deleteJob(idx){
  if(!confirm("Delete this job?")) return;
  const jobs = JSON.parse(localStorage.getItem("jobs")) || [];
  if(idx < 0 || idx >= jobs.length) return;
  const deleted = jobs[idx];
  const jobId = deleted.id;

  if(window.firebaseEnabled){
    const success = await window.firebaseDeleteJob(jobId);
    if(success){
      showToastAdmin("Job deleted and synced", 8000, true);
      localStorage.setItem('lastDeletedJob', JSON.stringify({ job: deleted, idx, time: Date.now() }));
      lastDeleted = { job: deleted, idx };
      if(selectedJobIdx === idx){ document.getElementById('jobDetailAdmin').style.display = 'none'; selectedJobIdx = null; }
      return; // Listener will refresh list
    } else {
      showToastAdmin("Firebase delete error ‚Äì falling back to local");
    }
  }

  // Local fallback
  jobs.splice(idx,1);
  localStorage.setItem("jobs", JSON.stringify(jobs));
  localStorage.setItem('lastDeletedJob', JSON.stringify({ job: deleted, idx, time: Date.now() }));
  lastDeleted = { job: deleted, idx };
  renderAdminJobs();
  showToastAdmin("Job deleted (local only)", 8000, true);
  if(selectedJobIdx === idx){ document.getElementById('jobDetailAdmin').style.display = 'none'; selectedJobIdx = null; }
}

async function editJob(idx){
  const jobs = JSON.parse(localStorage.getItem("jobs")) || [];
  if(idx < 0 || idx >= jobs.length) return;
  const current = jobs[idx].raw || jobs[idx].title || '';
  const updated = prompt("Edit job text (full text):", current);
  if(updated === null) return;
  const raw = updated.trim();
  if(!raw) return showToastAdmin("Job text cannot be empty");
  const firstLine = (raw.split('\n')[0] || "").replace(/^üéØ\s*/,'').trim();
  const title = firstLine || 'Untitled Job';
  const urlMatch = raw.match(/https?:\/\/\S+/i);
  const updatedJob = { ...jobs[idx], title, raw, apply: urlMatch ? urlMatch[0] : '' };

  if(window.firebaseEnabled){
    const success = await window.firebaseUpdateJob(updatedJob);
    if(success){
      showToastAdmin("Job updated and synced");
      showJobDetail(idx);
      return;
    } else {
      showToastAdmin("Firebase update error ‚Äì falling back to local");
    }
  }

  jobs[idx] = updatedJob;
  localStorage.setItem("jobs", JSON.stringify(jobs));
  renderAdminJobs();
  showJobDetail(idx);
  showToastAdmin("Job updated (local only)");
}

// Initial render
if(localStorage.getItem("admin")==="true") renderAdminJobs();

// Expose functions for firebase.js listeners
window.renderAdminJobs = renderAdminJobs;
window.renderAnnouncementAdmin = renderAnnouncementAdmin;
window.showToastAdmin = showToastAdmin;

</script>

</body>
</html>