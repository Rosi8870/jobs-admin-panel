<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">
<style>
/* Clean & Modern Admin Styles */
body { background: var(--bg); color: var(--text); font-family: system-ui, sans-serif; }
.admin-wrapper { max-width: 1200px; margin: 0 auto; padding: 20px var(--gutter); }
.top-header { text-align: center; padding: 20px 0; }
.top-header h1 { font-size: 1.8rem; margin: 0; }
.top-header p { opacity: 0.8; margin: 8px 0 0; }

.admin-card { background: var(--surface); border-radius: 16px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-bottom: 24px; }
.admin-card h3 { margin-top: 0; font-size: 1.3rem; }

textarea, input[type="password"] {
  width: 100%;
  padding: 16px;
  border-radius: 16px;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  color: white;
  font-size: 1rem;
  margin: 12px 0;
  box-sizing: border-box;
}

button {
  padding: 14px 20px;
  border-radius: 16px;
  border: none;
  font-weight: 600;
  cursor: pointer;
  transition: opacity 0.2s;
}
button:hover { opacity: 0.9; }

.btn-primary { background: var(--accent); color: white; width: 100%; font-size: 1.1rem; margin-top: 8px; }
.btn-primary-outline { background: transparent; color: var(--accent); border: 2px solid var(--accent); }
.danger { background: #ef4444; color: white; }

#jobsListAdmin > div, #chatJobsList > div {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  border-radius: 12px;
  margin-bottom: 12px;
  background: rgba(255,255,255,0.03);
}
#jobsListAdmin > div:hover, #chatJobsList > div:hover { background: rgba(255,255,255,0.08); }

#adminMetrics, #chatMetrics { font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; opacity: 0.9; }

.chat-message {
  max-width: 80%;
  padding: 12px 16px;
  border-radius: 18px;
  margin: 8px 0;
  word-wrap: break-word;
  background: rgba(255,255,255,0.1);
  position: relative;
}
.chat-message-admin {
  background: #0a84ff;
  color: white;
  align-self: flex-end;
  margin-left: auto;
  border-bottom-right-radius: 4px;
}
.chat-delete-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  background: none;
  border: none;
  color: #ef4444;
  font-size: 18px;
  cursor: pointer;
  opacity: 0.7;
}
.chat-delete-btn:hover { opacity: 1; }

.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: rgba(20,24,28,0.95);
  color: white;
  padding: 16px 20px;
  border-radius: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  z-index: 10000;
  transform: translateX(120%);
  transition: transform 0.4s ease;
}
.toast.show { transform: translateX(0); }
</style>
</head>
<body>

<header class="top-header">
  <h1>Admin Panel</h1>
  <p>Manage jobs, announcements & chat</p>
</header>

<div class="admin-wrapper">
  <div class="admin-card" id="loginBox">
    <h3>üîê Admin Login</h3>
    <input id="password" type="password" placeholder="Enter password">
    <button class="btn-primary" onclick="login()">Login</button>
  </div>

  <div class="admin-card" id="adminBox" style="display:none">
    <h3>‚ûï Post New Job</h3>
    <textarea id="jobText" rows="10" placeholder="üéØ Job Title
‚ú≥Ô∏è Role: ...
‚ùáÔ∏è Qualification: ...
üÉè Experience: ...
üîî Date/Location: ...
üëâ Apply Link: https://..."></textarea>
    <button class="btn-primary" onclick="postJob()">Publish Job</button>

    <h3 style="margin-top:32px">üìã Existing Jobs</h3>
    <div id="adminMetrics"></div>
    <div id="jobsListAdmin"></div>

    <hr style="margin:32px 0; border:none; border-top:1px solid rgba(255,255,255,0.1)">

    <h3>üí¨ Chat Management</h3>
    <div id="chatMetrics"></div>
    <div id="chatJobsList"></div>

    <div id="chatViewer" style="display:none;margin-top:20px">
      <h4>Chat for: <span id="chatViewerTitle"></span></h4>
      <div id="chatViewerMessages" style="max-height:50vh;overflow-y:auto;background:rgba(0,0,0,0.3);padding:16px;border-radius:12px"></div>
    </div>

    <hr style="margin:32px 0; border:none; border-top:1px solid rgba(255,255,255,0.1)">

    <h3>üì£ Announcement</h3>
    <textarea id="annText" rows="3" placeholder="Write announcement..."></textarea>
    <button class="btn-primary-outline" onclick="postAnnouncement()">Publish Announcement</button>
    <div id="currentAnnouncement" style="margin-top:16px"></div>

    <button class="danger" onclick="logout()" style="margin-top:32px">Logout</button>
  </div>
</div>

<div class="toast" id="toastAdmin">
  <span id="toastTextAdmin"></span>
  <button id="toastUndoBtn" style="display:none" onclick="restoreLastDeleted()">Undo</button>
  <button onclick="hideToastAdmin()">‚úï</button>
</div>

<script src="firebase-config.js"></script>
<script src="firebase.js"></script>
<script>
const ADMIN_PASSWORD = "change123";

let lastDeleted = null;

function login() {
  if (password.value === ADMIN_PASSWORD) {
    localStorage.setItem("admin", "true");
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("adminBox").style.display = "block";
    renderAdminJobs();
    renderChatJobs();
    renderAnnouncementAdmin();
  } else {
    showToastAdmin("Wrong password");
  }
}

function logout() {
  localStorage.removeItem("admin");
  location.reload();
}

if (localStorage.getItem("admin") === "true") {
  document.getElementById("loginBox").style.display = "none";
  document.getElementById("adminBox").style.display = "block";
}

function showToastAdmin(txt, duration = 5000, showUndo = false) {
  const t = document.getElementById('toastAdmin');
  const tt = document.getElementById('toastTextAdmin');
  const undo = document.getElementById('toastUndoBtn');
  tt.innerText = txt;
  undo.style.display = showUndo ? 'inline-block' : 'none';
  t.classList.add('show');
  clearTimeout(t._timeout);
  t._timeout = setTimeout(() => t.classList.remove('show'), duration);
}

function hideToastAdmin() {
  document.getElementById('toastAdmin').classList.remove('show');
}

// Jobs List - Views & Applies work
function renderAdminJobs() {
  const jobs = JSON.parse(localStorage.getItem("jobs") || "[]");
  const list = document.getElementById("jobsListAdmin");
  list.innerHTML = jobs.length === 0 ? "<p style='opacity:0.7;text-align:center;padding:40px'>No jobs posted</p>" : "";

  const totalViews = jobs.reduce((s, j) => s + (j.views || 0), 0);
  const totalApplies = jobs.reduce((s, j) => s + (j.applies || 0), 0);
  document.getElementById('adminMetrics').innerText = `Total Views: ${totalViews} ‚Ä¢ Total Applies: ${totalApplies}`;

  jobs.forEach((job, idx) => {
    const excerpt = (job.raw || "").split('\n')[1] || (job.raw || "").split('\n')[0]?.slice(0,60) + '...';
    const row = document.createElement("div");
    row.innerHTML = `
      <div>
        <strong>${job.title || 'Untitled'}</strong>
        <div style="opacity:0.85;font-size:0.95rem;margin:6px 0">${excerpt || 'No preview'}</div>
        <div style="opacity:0.7;font-size:0.9rem">üëÅÔ∏è ${job.views || 0} views ‚Ä¢ üîó ${job.applies || 0} applies</div>
      </div>
      <div style="display:flex;gap:10px">
        <button onclick="event.stopPropagation(); editJob(${idx})" style="padding:8px 14px;border-radius:10px;background:#0a84ff;border:none;color:white;cursor:pointer">Edit</button>
        <button onclick="event.stopPropagation(); deleteJob(${idx})" style="padding:8px 14px;border-radius:10px;background:#ef4444;border:none;color:white;cursor:pointer">Delete</button>
      </div>
    `;
    list.appendChild(row);
  });
}

// Chat Management - Robust connection check
async function renderChatJobs() {
  const list = document.getElementById("chatJobsList");
  const metrics = document.getElementById("chatMetrics");

  const isConnected = typeof firebase !== 'undefined' && firebase.apps.length > 0;

  if (!isConnected) {
    metrics.innerText = "Firebase not connected";
    list.innerHTML = "<p style='opacity:0.7;text-align:center;padding:40px'>Firebase connection required for chat management</p>";
    return;
  }

  metrics.innerText = "Loading chats...";
  list.innerHTML = "";

  const jobs = JSON.parse(localStorage.getItem("jobs") || "[]");
  let totalMessages = 0;

  for (const job of jobs) {
    try {
      const chatsSnap = await firebase.firestore().collection('jobs').doc(job.id).collection('chats').get();
      const msgCount = chatsSnap.size;
      totalMessages += msgCount;

      if (msgCount > 0) {
        const row = document.createElement("div");
        row.innerHTML = `
          <div>
            <strong>${job.title || 'Untitled Job'}</strong>
            <div style="opacity:0.8;font-size:0.9rem">${msgCount} message${msgCount > 1 ? 's' : ''}</div>
          </div>
          <button onclick="openChatViewer('${job.id}', '${(job.title || 'Untitled').replace(/'/g, "\\'")}')" style="padding:8px 14px;border-radius:10px;background:#25D366;border:none;color:white;cursor:pointer">View & Manage</button>
        `;
        list.appendChild(row);
      }
    } catch (err) {
      console.error("Error loading chat for job:", job.id, err);
    }
  }

  metrics.innerText = `Total Chat Messages: ${totalMessages}`;
}

function openChatViewer(jobId, jobTitle) {
  document.getElementById('chatViewerTitle').innerText = jobTitle;
  document.getElementById('chatViewer').style.display = 'block';
  const messagesDiv = document.getElementById('chatViewerMessages');
  messagesDiv.innerHTML = '<p style="text-align:center;opacity:0.6">Loading messages...</p>';

  firebase.firestore().collection('jobs').doc(jobId).collection('chats').orderBy('timestamp', 'asc').onSnapshot(snap => {
    messagesDiv.innerHTML = '';
    if (snap.empty) {
      messagesDiv.innerHTML = '<p style="text-align:center;opacity:0.6">No messages yet</p>';
      return;
    }
    snap.forEach(doc => {
      const msg = doc.data();
      const bubble = document.createElement('div');
      bubble.className = 'chat-message';
      if (msg.isMine) bubble.className += ' chat-message-admin';
      bubble.innerHTML = `${msg.text || ''}<button class="chat-delete-btn" onclick="deleteChatMessage('${jobId}', '${doc.id}')">üóëÔ∏è</button>`;
      messagesDiv.appendChild(bubble);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }, err => {
    showToastAdmin("Failed to load chat");
  });
}

function deleteChatMessage(jobId, messageId) {
  if (!confirm("Delete this message permanently?")) return;
  firebase.firestore().collection('jobs').doc(jobId).collection('chats').doc(messageId).delete()
    .then(() => {
      showToastAdmin("Message deleted");
      renderChatJobs(); // Refresh counts
    })
    .catch(err => {
      console.error(err);
      showToastAdmin("Delete failed");
    });
}

// Post Job
async function postJob() {
  const raw = jobText.value.trim();
  if (!raw) return showToastAdmin("Enter job details");

  const title = raw.split('\n')[0].replace(/^üéØ\s*/, '').trim() || 'Untitled Job';
  const apply = raw.match(/https?:\/\/\S+/)?.[0] || '';
  const id = 'job_' + Date.now();

  const job = { id, title, raw, apply, views: 0, applies: 0, createdAt: Date.now() };

  if (window.firebaseEnabled) {
    const success = await window.firebasePushJob(job);
    if (success) {
      showToastAdmin("Job posted & synced");
      jobText.value = "";
      renderAdminJobs();
      renderChatJobs();
      return;
    }
  }

  const jobs = JSON.parse(localStorage.getItem("jobs") || "[]");
  jobs.unshift(job);
  localStorage.setItem("jobs", JSON.stringify(jobs));
  renderAdminJobs();
  renderChatJobs();
  showToastAdmin("Job posted (local)");
  jobText.value = "";
}

// Edit Job
async function editJob(idx) {
  const jobs = JSON.parse(localStorage.getItem("jobs") || "[]");
  if (idx >= jobs.length) return;
  const updated = prompt("Edit job (full text):", jobs[idx].raw || '');
  if (updated === null || !updated.trim()) return;

  const raw = updated.trim();
  const title = raw.split('\n')[0].replace(/^üéØ\s*/, '').trim() || 'Untitled';
  const apply = raw.match(/https?:\/\/\S+/)?.[0] || '';
  const newJob = { ...jobs[idx], title, raw, apply };

  if (window.firebaseEnabled) {
    const success = await window.firebaseUpdateJob(newJob);
    if (success) {
      showToastAdmin("Job updated & synced");
      renderAdminJobs();
      renderChatJobs();
      return;
    }
  }

  jobs[idx] = newJob;
  localStorage.setItem("jobs", JSON.stringify(jobs));
  renderAdminJobs();
  renderChatJobs();
  showToastAdmin("Job updated (local)");
}

// Delete Job
async function deleteJob(idx) {
  if (!confirm("Delete this job permanently?")) return;
  const jobs = JSON.parse(localStorage.getItem("jobs") || "[]");
  const deleted = jobs[idx];

  if (window.firebaseEnabled) {
    const success = await window.firebaseDeleteJob(deleted.id);
    if (success) {
      showToastAdmin("Job deleted & synced", 8000, true);
      localStorage.setItem("lastDeletedJob", JSON.stringify({job: deleted, idx}));
      renderAdminJobs();
      renderChatJobs();
      return;
    }
  }

  jobs.splice(idx, 1);
  localStorage.setItem("jobs", JSON.stringify(jobs));
  localStorage.setItem("lastDeletedJob", JSON.stringify({job: deleted, idx}));
  renderAdminJobs();
  renderChatJobs();
  showToastAdmin("Job deleted (local)", 8000, true);
}

function restoreLastDeleted() {
  const data = localStorage.getItem("lastDeletedJob");
  if (!data) return showToastAdmin("Nothing to restore");
  const {job, idx} = JSON.parse(data);
  const jobs = JSON.parse(localStorage.getItem("jobs") || "[]");
  jobs.splice(idx, 0, job);
  localStorage.setItem("jobs", JSON.stringify(jobs));
  localStorage.removeItem("lastDeletedJob");
  renderAdminJobs();
  renderChatJobs();
  showToastAdmin("Job restored!");
}

// Announcement
async function postAnnouncement() {
  const text = annText.value.trim();
  if (!text) return showToastAdmin("Enter announcement text");

  if (window.firebaseEnabled) {
    const success = await window.firebaseSetAnnouncement(text);
    if (success) showToastAdmin("Announcement posted & synced");
  } else {
    localStorage.setItem("announcement", text);
    showToastAdmin("Announcement saved locally");
  }
  annText.value = "";
  renderAnnouncementAdmin();
}

function renderAnnouncementAdmin() {
  const ann = localStorage.getItem("announcement") || "";
  const el = document.getElementById("currentAnnouncement");
  if (!ann) {
    el.innerHTML = "<p style='opacity:0.7'>No active announcement</p>";
    return;
  }
  el.innerHTML = `
    <div style="padding:16px;background:rgba(255,255,255,0.05);border-radius:12px">${ann}</div>
    <div style="margin-top:12px;display:flex;gap:10px">
      <button class="btn-primary-outline" onclick="annText.value='${ann.replace(/'/g, "\\'")}';annText.focus()">Edit</button>
      <button class="danger" onclick="if(confirm('Delete?')){window.firebaseEnabled?window.firebaseSetAnnouncement(''):localStorage.removeItem('announcement');renderAnnouncementAdmin();showToastAdmin('Deleted')}">Delete</button>
    </div>
  `;
}

// Initial load
if (localStorage.getItem("admin") === "true") {
  renderAdminJobs();
  renderChatJobs();
  renderAnnouncementAdmin();
}

// Re-render chat jobs after delete
window.renderChatJobs = renderChatJobs;

// Expose for firebase.js
window.renderAdminJobs = renderAdminJobs;
window.renderAnnouncementAdmin = renderAnnouncementAdmin;
window.showToastAdmin = showToastAdmin;
</script>
</body>
</html>
